<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deploy UI — Dark Console</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Orbitron:wght@700&display=swap');

    :root {
      --bg: radial-gradient(circle at center, #1a2e4e 0%, #0a0f2f 100%); /* Blue theme default */
      --panel: linear-gradient(135deg, rgba(25, 30, 40, 0.7), rgba(55, 60, 80, 0.7)); /* Blue glassmorphism */
      --muted: #a0a7b5; /* Softer gray for text */
      --accent: #1e40af; /* Blue accent */
      --neon-red: #1e3a8a; /* Darker blue for gradients */
      --deep-blue: #1e3a8a; /* Deep blue for contrast */
      --success: #22c55e; /* Bright green for success */
      --warn: #f59e0b; /* Warm amber for warnings */
      --err: #1e40af; /* Blue for errors */
      --glass: rgba(255, 255, 255, 0.08); /* Glass effect */
      --glow: rgba(30, 64, 175, 0.5); /* Blue glowing accent */
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Poppins', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
      font-weight: 400;
      background: var(--bg);
      color: #e2e8f0;
      position: relative;
      overflow-y: auto; /* Enable scrollbar only when content exceeds viewport */
      animation: fadeIn 1s ease-in;
    }

    /* Dynamic starry background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      z-index: -1;
    }

    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
      background-size: 50px 50px;
      animation: starTwinkle 10s linear infinite;
      opacity: 0.3;
      z-index: -1;
    }

    @keyframes starTwinkle {
      0% { background-position: 0 0; opacity: 0.3; }
      50% { opacity: 0.5; }
      100% { background-position: 50px 50px; opacity: 0.3; }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 8px var(--glow); }
      50% { box-shadow: 0 0 16px var(--glow); }
      100% { box-shadow: 0 0 8px var(--glow); }
    }

    @keyframes slideIn {
      from { transform: translateX(-10px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes typing {
      from { transform: translateX(-5px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .app {
      display: grid;
      grid-template-columns: 360px 1fr 360px;
      min-height: 100vh;
      gap: 12px;
      padding: 12px;
      box-sizing: border-box;
    }

    .card {
      background: var(--panel);
      backdrop-filter: blur(12px); /* Enhanced blur */
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.8), 0 0 12px var(--glow);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
      min-height: 618px; /* Balance UI + Middleware and MARKLOGIC panels */
      position: relative; /* Ensure sticky positioning works within card */
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.9), 0 0 20px var(--glow);
    }

    /* Controls */
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex-grow: 1; /* Ensure content stretches to fill panel */
    }

    .h {
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      font-size: 14px;
      color: var(--accent);
      letter-spacing: 0.8px;
      text-transform: uppercase;
    }

    label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input[type="text"], select {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      background: rgba(20, 25, 30, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #f3f4f6;
      font-size: 12px;
      font-weight: 400;
      outline: none;
      transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
      box-sizing: border-box;
    }

    input[type="text"]:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 10px var(--glow);
      animation: pulse 1.5s infinite;
      transform: scale(1.02);
    }

    .row {
      display: flex;
      gap: 8px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.3s ease;
    }

    .btn.primary {
      background: linear-gradient(90deg, var(--accent), var(--neon-red));
      color: white;
      box-shadow: 0 0 12px var(--glow);
    }

    .btn.primary:hover {
      background: linear-gradient(90deg, var(--accent), var(--neon-red));
      transform: scale(1.05);
      animation: pulse 1.5s infinite;
      box-shadow: 0 0 20px var(--glow);
    }

    .btn.ghost {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: var(--muted);
    }

    .btn.ghost:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #f3f4f6;
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .small {
      font-size: 11px;
      padding: 6px 10px;
    }

    /* Terminal */
    .terminal {
      background: #0c0c12;
      border-radius: 10px;
      padding: 12px;
      flex-grow: 1;
      max-height: 70vh;
      overflow-y: auto;
      box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.9), 0 0 15px var(--glow);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .line {
      font-family: 'Roboto Mono', ui-monospace, monospace;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 12px;
      line-height: 1.5;
      color: #e2e8f0;
    }

    .line[data-new="true"] {
      animation: typing 0.3s ease-out;
    }

    .ts {
      color: var(--muted);
      font-size: 10px;
      margin-right: 8px;
    }

    .stdout { color: var(--success); }
    .stderr { color: var(--err); }
    .warn { color: var(--warn); }
    .info { color: var(--accent); }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      flex-shrink: 0;
    }

    .meta {
      color: var(--muted);
      font-size: 11px;
      font-weight: 600;
    }

    /* Spinner */
    .spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 0.8s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Misc */
    .badge {
      background: var(--glass);
      padding: 5px 8px;
      border-radius: 999px;
      font-size: 10px;
      color: var(--muted);
      border: 1px solid var(--glow);
      transition: transform 0.3s ease;
    }

    .badge:hover {
      transform: scale(1.05);
    }

    /* History list */
    ul.history-list {
      list-style: none;
      padding: 0;
      margin: 8px 0 0 0;
      background: var(--panel);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(12px);
    }

    ul.history-list#frHistory {
      height: 296px; /* Fits 6 history items (6 × ~48px + 8px margin) */
      overflow-y: auto; /* Vertical scrollbar for more than 6 items */
      overflow-x: hidden; /* Prevent horizontal scrollbar */
    }

    ul.history-list li {
      padding: 6px 10px;
      cursor: pointer;
      font-size: 10px;
      position: relative;
      padding-left: 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: background 0.3s ease, transform 0.2s ease, color 0.3s ease;
    }

    ul.history-list li[data-new="true"] {
      animation: slideIn 0.3s ease-out;
    }

    ul.history-list li:last-child {
      border-bottom: none;
    }

    ul.history-list li:hover {
      color: var(--accent);
      background: rgba(255, 255, 255, 0.05);
      transform: translateX(4px);
    }

    ul.history-list li::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    ul.history-list li[status="true"]::before {
      background-color: var(--success);
      box-shadow: 0 0 8px var(--success);
    }

    ul.history-list li[status="false"]::before {
      background-color: var(--err);
      box-shadow: 0 0 8px var(--err);
    }

    .history-item {
      display: flex;
      flex-direction: column;
      gap: 3px;
      position: relative;
      word-break: break-word; /* Wrap long text to prevent horizontal overflow */
    }

    .history-item .datetime {
      position: absolute;
      top: 6px;
      right: 10px;
      font-size: 9px;
      color: var(--muted);
      word-break: break-word; /* Wrap long date/time */
    }

    .history-item span:not(.datetime) {
      display: block;
      font-size: 10px;
      color: var(--muted);
      word-break: break-word; /* Wrap long version strings */
    }

    .history-item .build-id {
      font-weight: 600;
      font-size: 11px;
      color: #f3f4f6;
      word-break: break-word; /* Wrap long build IDs */
    }

    /* Sticky buttons (viewport-level) */
    .sticky-buttons {
      position: fixed;
      bottom: 16px;
      left: 50%; /* Center horizontally */
      transform: translateX(-50%); /* Adjust for centering */
      z-index: 1000;
      display: flex;
      flex-direction: row; /* Horizontal layout */
      gap: 8px;
    }

    .sticky-button {
      background: linear-gradient(90deg, var(--accent), var(--neon-red));
      color: white;
      box-shadow: 0 0 15px var(--glow);
      border-radius: 8px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      font-size: 11px;
      padding: 6px 10px;
    }

    .sticky-button:hover {
      transform: scale(1.05);
      animation: pulse 1.5s infinite;
      box-shadow: 0 0 20px var(--glow);
    }

    /* Toggle button (inside MARKLOGIC panel) */
    .color-balls {
      position: sticky;
      bottom: 16px; /* Align with panel padding */
      right: 16px; /* Bottom-right corner of MARKLOGIC panel */
    }

    .toggle-auto {
      background: linear-gradient(90deg, var(--accent), var(--neon-red));
      color: white;
      box-shadow: 0 0 15px var(--glow);
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 11px;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .toggle-auto:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px var(--glow);
      animation: pulse 1.5s infinite;
    }

    @media (max-width: 900px) {
      .app {
        grid-template-columns: 1fr;
        grid-auto-rows: auto;
        padding: 10px;
        min-height: 100vh;
      }

      .terminal {
        max-height: 40vh;
        flex-grow: 1;
        overflow-y: auto;
      }

      .sticky-buttons {
        bottom: 10px;
        left: 50%; /* Keep centered */
        transform: translateX(-50%); /* Adjust for centering */
        flex-direction: row; /* Keep horizontal */
      }

      .color-balls {
        bottom: 10px; /* Adjusted for mobile, align with panel padding */
        right: 10px; /* Bottom-right corner of MARKLOGIC panel */
      }

      ul.history-list#frHistory {
        height: 290px; /* Slightly adjusted for mobile to fit 6 items */
        overflow-y: auto;
        overflow-x: hidden; /* Prevent horizontal scrollbar */
      }
    }

    /* Main section adjustments */
    main {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    #terminal {
      flex-grow: 1;
      max-height: 70vh;
      overflow-y: auto;
    }

    .header {
      flex-shrink: 0;
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="card">
      <div class="header">
        <div>
          <div class="h">Deploy Control - UI + Middleware</div>
          <div class="meta">SERVER: <span style="color:var(--accent)">api.dashboard.dev-full.lifesciences-dev.casinternal:8080</span></div>
        </div>
        <div class="badge">Dark</div>
      </div>

      <div class="controls">
        <div>
          <label>UI and Middleware Version</label>
          <input id="frVersion" type="text" placeholder="e.g. 1.2.3" value="" />
          <label style="margin-top:8px">Structure Search Version</label>
          <input id="structureVersion" type="text" placeholder="e.g. 2025-09-01" value="" />
          <div style="margin-top:8px" class="row">
            <button id="btnDeployFR" class="btn primary">Deploy UI + Middleware</button>
            <button id="btnAbortFR" class="btn ghost small">Abort</button>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:6px 0">

        <div>
          <div style="font-weight:700">History</div>
          <ul id="frHistory" class="history-list"></ul>
        </div>
      </div>
    </aside>

    <main class="card">
      <div class="header">
        <div>
          <div style="font-weight:700;font-size:16px">Live Console</div>
          <div class="meta">Shows live stdout/stderr from deployment APIs</div>
        </div>
        <div class="meta" id="status">Idle</div>
      </div>

      <div id="terminal" class="terminal" aria-live="polite"></div>
    </main>

    <aside class="card">
      <div class="header">
        <div>
          <div class="h">Deploy Control - MARKLOGIC</div>
          <div class="meta">SERVER: <span style="color:var(--accent)">api.dashboard.dev-full.lifesciences-dev.casinternal:8080</span></div>
        </div>
        <div class="badge">Dark</div>
      </div>

      <div class="controls">
        <div>
          <div style="margin-top:8px" class="row">
            <button id="btnDeployML" class="btn primary">Deploy MARKLOGIC</button>
            <button id="btnAbortML" class="btn ghost small">Abort</button>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:6px 0">

        <div>
          <div style="font-weight:700">History</div>
          <ul id="mlHistory" class="history-list"></ul>
        </div>
      </div>

      <div class="color-balls">
        <button id="toggleAuto" class="toggle-auto">Stop Auto-Change</button>
      </div>
    </aside>
  </div>

  <div class="sticky-buttons">
    <button id="btnCopy" class="btn ghost small sticky-button">Copy</button>
    <button id="btnDownload" class="btn ghost small sticky-button">Download Log</button>
    <button id="btnClear" class="btn ghost small sticky-button">Clear Terminal</button>
  </div>

  <script>
    // Configuration - UPDATE THIS TO YOUR ACTUAL SERVER
    const SERVER = 'http://api.dashboard.dev-full.lifesciences-dev.casinternal:8080';
    const COLOR_CHANGE_INTERVAL = 5000; // Configure auto-change interval (ms)

    // Theme configuration
    const themes = {
      red: {
        '--accent': '#ef4444',
        '--neon-red': '#b91c1c',
        '--glow': 'rgba(239, 68, 68, 0.5)',
        '--panel': 'linear-gradient(135deg, rgba(20, 25, 30, 0.7), rgba(50, 55, 60, 0.7))',
        '--bg': 'radial-gradient(circle at center, #1a1a2e 0%, #0a0a0f 100%)',
        '--success': '#22c55e',
        '--warn': '#f59e0b',
        '--err': '#ef4444'
      },
      black: {
        '--accent': '#334155',
        '--neon-red': '#1e293b',
        '--glow': 'rgba(51, 65, 85, 0.5)',
        '--panel': 'linear-gradient(135deg, rgba(30, 30, 30, 0.7), rgba(60, 60, 60, 0.7))',
        '--bg': 'radial-gradient(circle at center, #0f0f0f 0%, #000000 100%)',
        '--success': '#22c55e',
        '--warn': '#f59e0b',
        '--err': '#334155'
      },
      purple: {
        '--accent': '#7e22ce',
        '--neon-red': '#5b21b6',
        '--glow': 'rgba(126, 34, 206, 0.5)',
        '--panel': 'linear-gradient(135deg, rgba(30, 25, 40, 0.7), rgba(60, 55, 80, 0.7))',
        '--bg': 'radial-gradient(circle at center, #2e1a3e 0%, #0f071a 100%)',
        '--success': '#22c55e',
        '--warn': '#f59e0b',
        '--err': '#7e22ce'
      },
      blue: {
        '--accent': '#1e40af',
        '--neon-red': '#1e3a8a',
        '--glow': 'rgba(30, 64, 175, 0.5)',
        '--panel': 'linear-gradient(135deg, rgba(25, 30, 40, 0.7), rgba(55, 60, 80, 0.7))',
        '--bg': 'radial-gradient(circle at center, #1a2e4e 0%, #0a0f2f 100%)',
        '--success': '#22c55e',
        '--warn': '#f59e0b',
        '--err': '#1e40af'
      },
      green: {
        '--accent': '#15803d',
        '--neon-red': '#166534',
        '--glow': 'rgba(21, 128, 61, 0.5)',
        '--panel': 'linear-gradient(135deg, rgba(25, 35, 30, 0.7), rgba(55, 65, 60, 0.7))',
        '--bg': 'radial-gradient(circle at center, #1a2e1e 0%, #0a0f0a 100%)',
        '--success': '#22c55e',
        '--warn': '#f59e0b',
        '--err': '#15803d'
      },
      orange: {
        '--accent': '#ea580c',
        '--neon-red': '#c2410c',
        '--glow': 'rgba(234, 88, 12, 0.5)',
        '--panel': 'linear-gradient(135deg, rgba(35, 30, 25, 0.7), rgba(65, 60, 55, 0.7))',
        '--bg': 'radial-gradient(circle at center, #3e2a1a 0%, #1a0f0a 100%)',
        '--success': '#22c55e',
        '--warn': '#f59e0b',
        '--err': '#ea580c'
      },
      cyan: {
        '--accent': '#06b6d4',
        '--neon-red': '#0891b2',
        '--glow': 'rgba(6, 182, 212, 0.5)',
        '--panel': 'linear-gradient(135deg, rgba(20, 30, 35, 0.7), rgba(50, 60, 65, 0.7))',
        '--bg': 'radial-gradient(circle at center, #1a2e4e 0%, #0a1a2f 100%)',
        '--success': '#22c55e',
        '--warn': '#f59e0b',
        '--err': '#06b6d4'
      },
      pink: {
        '--accent': '#ec4899',
        '--neon-red': '#be185d',
        '--glow': 'rgba(236, 72, 153, 0.5)',
        '--panel': 'linear-gradient(135deg, rgba(30, 25, 35, 0.7), rgba(60, 55, 65, 0.7))',
        '--bg': 'radial-gradient(circle at center, #2e1a3e 0%, #1a0a1f 100%)',
        '--success': '#22c55e',
        '--warn': '#f59e0b',
        '--err': '#ec4899'
      },
      yellow: {
        '--accent': '#eab308',
        '--neon-red': '#ca8a04',
        '--glow': 'rgba(234, 179, 8, 0.5)',
        '--panel': 'linear-gradient(135deg, rgba(35, 30, 25, 0.7), rgba(65, 60, 55, 0.7))',
        '--bg': 'radial-gradient(circle at center, #3e2e1a 0%, #1a0f0a 100%)',
        '--success': '#22c55e',
        '--warn': '#f59e0b',
        '--err': '#eab308'
      },
      teal: {
        '--accent': '#14b8a6',
        '--neon-red': '#0d9488',
        '--glow': 'rgba(20, 184, 166, 0.5)',
        '--panel': 'linear-gradient(135deg, rgba(25, 35, 30, 0.7), rgba(55, 65, 60, 0.7))',
        '--bg': 'radial-gradient(circle at center, #1a2e2e 0%, #0a1a1a 100%)',
        '--success': '#22c55e',
        '--warn': '#f59e0b',
        '--err': '#14b8a6'
      }
    };

    // Apply theme
    function applyTheme(themeName) {
      const theme = themes[themeName];
      for (const [key, value] of Object.entries(theme)) {
        document.documentElement.style.setProperty(key, value);
      }
    }

    // Auto theme change
    const themeNames = ['red', 'black', 'purple', 'blue', 'green', 'orange', 'cyan', 'pink', 'yellow', 'teal'];
    let currentThemeIndex = 3; // Start with blue (index of blue in themeNames)
    let isAutoChangeEnabled = true;
    let autoThemeInterval = null;

    function startAutoThemeChange() {
      if (!isAutoChangeEnabled) return;
      autoThemeInterval = setInterval(() => {
        currentThemeIndex = (currentThemeIndex + 1) % themeNames.length;
        applyTheme(themeNames[currentThemeIndex]);
      }, COLOR_CHANGE_INTERVAL);
    }

    function stopAutoThemeChange() {
      if (autoThemeInterval) {
        clearInterval(autoThemeInterval);
        autoThemeInterval = null;
      }
    }

    // Toggle auto-change
    document.getElementById('toggleAuto').addEventListener('click', () => {
      isAutoChangeEnabled = !isAutoChangeEnabled;
      const toggleButton = document.getElementById('toggleAuto');
      toggleButton.textContent = isAutoChangeEnabled ? 'Stop Auto-Change' : 'Start Auto-Change';
      toggleButton.style.background = isAutoChangeEnabled
        ? 'linear-gradient(90deg, var(--accent), var(--neon-red))'
        : 'rgba(255, 255, 255, 0.1)';
      toggleButton.style.color = isAutoChangeEnabled ? 'white' : 'var(--muted)';
      if (isAutoChangeEnabled) {
        startAutoThemeChange();
      } else {
        stopAutoThemeChange();
      }
    });

    // Start auto theme change on load
    startAutoThemeChange();

    // State
    const terminal = document.getElementById('terminal');
    const statusEl = document.getElementById('status');
    let lastIndex = 0;
    let xhrFR = null, xhrML = null;
    let logBuffer = '';
    let isDeploying = false;

    function appendLine(text, kind='stdout'){
      const parts = text.replace(/\r/g,'').split(/\n/);
      parts.forEach((p, idx) => {
        if(!p) return;
        const ts = new Date().toLocaleTimeString();
        const line = document.createElement('div');
        line.className = 'line ' + (kind==='stderr' ? 'stderr' : kind==='warn' ? 'warn' : kind==='info' ? 'info' : 'stdout');
        line.setAttribute('data-new', 'true');
        line.innerHTML = '<span class="ts">['+ts+']</span>' + escapeHtml(p);
        terminal.appendChild(line);
        logBuffer += '['+ts+'] ' + p + '\n';
        // Auto-scroll to bottom if user is near the bottom
        const isNearBottom = terminal.scrollTop + terminal.clientHeight >= terminal.scrollHeight - 50; // 50px threshold
        if (isNearBottom) {
          terminal.scrollTop = terminal.scrollHeight;
        }
        // Remove data-new after animation
        setTimeout(() => line.removeAttribute('data-new'), 300);
      });
    }

    function escapeHtml(s){
      return s.replace(/[&<>\"']/g, function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]});
    }

    function processChunk(chunk){
      const lines = chunk.split(/\r?\n/);
      lines.forEach(l => {
        if(!l) return;
        if(/error/i.test(l) || /traceback/i.test(l) || /failed/i.test(l)) appendLine(l,'stderr');
        else if(/warn/i.test(l)) appendLine(l,'warn');
        else if(/info/i.test(l)) appendLine(l,'info');
        else appendLine(l,'stdout');
      });
    }

    function setButtonState(buttonId, isLoading, isAbort = false) {
      const btn = document.getElementById(buttonId);
      const otherDeployBtn = buttonId === 'btnDeployFR' ? document.getElementById('btnDeployML') : document.getElementById('btnDeployFR');
      if (isLoading) {
        btn.disabled = true;
        btn.innerHTML = isLoading ? 
          '<span class="spinner"></span> ' + (isAbort ? 'Aborting...' : 'Deploying...') : 
          btn.textContent;
        otherDeployBtn.disabled = true;
      } else {
        btn.disabled = false;
        btn.innerHTML = isAbort ? 'Abort' : (buttonId === 'btnDeployFR' ? 'Deploy UI + Middleware' : 'Deploy MARKLOGIC');
        if (!isDeploying) {
          otherDeployBtn.disabled = false;
        }
      }
    }

    function startStream(url, onDone, assignXhr){
      const xhr = new XMLHttpRequest();
      xhr.open('GET', url, true);
      xhr.timeout = 0;
      xhr.onreadystatechange = function(){
        if(xhr.readyState === 2){ 
          statusEl.textContent = 'Connected'; 
          statusEl.style.color = 'var(--success)';
        }
        if(xhr.readyState === 4){
          if(xhr.status >= 400) {
            statusEl.textContent = 'Failed (' + xhr.status + ')';
            statusEl.style.color = 'var(--err)';
            appendLine('HTTP ' + xhr.status + ' returned from server', 'stderr');
          } else {
            statusEl.textContent = 'Complete (' + xhr.status + ')';
            statusEl.style.color = 'var(--success)';
          }
          isDeploying = false;
          if(onDone) onDone(xhr);
        }
      };

      let lastLen = 0;
      xhr.onprogress = function(){
        const text = xhr.responseText.substring(lastLen);
        lastLen = xhr.responseText.length;
        if(text) processChunk(text);
      };

      xhr.onerror = function(){ 
        statusEl.textContent = 'Network Error'; 
        statusEl.style.color = 'var(--err)';
        appendLine('Network error while streaming', 'stderr'); 
        isDeploying = false;
      };
      
      xhr.ontimeout = function(){ 
        statusEl.textContent = 'Timeout'; 
        statusEl.style.color = 'var(--err)';
        appendLine('Streaming timed out', 'stderr'); 
        isDeploying = false;
      };

      xhr.send();
      assignXhr(xhr);
    }

    function validateInputs() {
      const fr = document.getElementById('frVersion').value.trim();
      const ss = document.getElementById('structureVersion').value.trim();
      
      if(!fr) {
        appendLine('UI and Middleware version is required', 'stderr');
        return false;
      }
      
      if(!ss) {
        appendLine('Structure Search version is required', 'stderr');
        return false;
      }
      
      return true;
    }

    function fetchFRHistory() {
      fetch(`${SERVER}/api/v1/history/fr`)
        .then(res => res.json())
        .then(data => {
          const sorted = data.sort((a, b) => new Date(b.datetime) - new Date(a.datetime)).slice(0, 10);
          const ul = document.getElementById('frHistory');
          ul.innerHTML = '';
          if (sorted.length > 0) {
            // Prepopulate input fields with the latest build's versions
            const latest = sorted[0];
            document.getElementById('frVersion').value = latest['fr-version'] || '';
            document.getElementById('structureVersion').value = latest['structure-search-version'] || '';
          }
          sorted.forEach(item => {
            const date = new Date(item.datetime).toLocaleDateString();
            const time = new Date(item.datetime).toLocaleTimeString();
            const li = document.createElement('li');
            li.setAttribute('status', item.status);
            li.setAttribute('data-new', 'true');
            li.innerHTML = `
              <div class="history-item">
                <span class="datetime">${date} ${time}</span>
                <span class="build-id">${escapeHtml(item.buildId)}</span>
                <span>UI and Middleware Version: ${escapeHtml(item['fr-version'] || 'N/A')}</span>
                <span>Structure Search Version: ${escapeHtml(item['structure-search-version'] || 'N/A')}</span>
              </div>
            `;
            li.style.cursor = 'pointer';
            li.onclick = () => viewLogs('fr', item.buildId);
            ul.appendChild(li);
            setTimeout(() => li.removeAttribute('data-new'), 300);
          });
        })
        .catch(err => appendLine('Error fetching UI and Middleware history: ' + err.message, 'stderr'));
    }

    function fetchMLHistory() {
      fetch(`${SERVER}/api/v1/history/ml`)
        .then(res => res.json())
        .then(data => {
          const sorted = data.sort((a, b) => new Date(b.datetime) - new Date(a.datetime)).slice(0, 10);
          const ul = document.getElementById('mlHistory');
          ul.innerHTML = '';
          sorted.forEach(item => {
            const date = new Date(item.datetime).toLocaleDateString();
            const time = new Date(item.datetime).toLocaleTimeString();
            const li = document.createElement('li');
            li.setAttribute('status', item.status);
            li.setAttribute('data-new', 'true');
            li.innerHTML = `
              <div class="history-item">
                <span class="build-id">${escapeHtml(item.buildId)}</span>
                <span>${date} - ${time}</span>
              </div>
            `;
            li.style.cursor = 'pointer';
            li.onclick = () => viewLogs('ml', item.buildId);
            ul.appendChild(li);
            setTimeout(() => li.removeAttribute('data-new'), 300);
          });
        })
        .catch(err => appendLine('Error fetching MARKLOGIC history: ' + err.message, 'stderr'));
    }

    function viewLogs(type, buildId) {
      terminal.innerHTML = '';
      logBuffer = '';
      statusEl.textContent = `Viewing ${type.toUpperCase()} Build ${buildId} Logs`;
      statusEl.style.color = 'var(--muted)';
      fetch(`${SERVER}/api/v1/history/${type}?buildId=${buildId}`)
        .then(res => res.json())
        .then(data => {
          if (data && data.output_log) {
            processChunk(data.output_log);
          } else {
            appendLine('No output log available for this build', 'warn');
          }
        })
        .catch(err => appendLine('Error fetching logs: ' + err.message, 'stderr'));
    }

    // Deploy FR
    document.getElementById('btnDeployFR').addEventListener('click', ()=>{
      if (isDeploying) {
        appendLine('Cannot start UI and Middleware deployment: another deployment is in progress', 'warn');
        return;
      }
      if (!validateInputs()) return;
      
      const fr = encodeURIComponent(document.getElementById('frVersion').value.trim());
      const ss = encodeURIComponent(document.getElementById('structureVersion').value.trim());
      
      terminal.innerHTML = '';
      logBuffer = '';
      lastIndex = 0;
      statusEl.textContent = 'Starting UI and Middleware deploy...';
      statusEl.style.color = 'var(--warn)';
      
      isDeploying = true;
      setButtonState('btnDeployFR', true);
      setButtonState('btnAbortFR', false, true);
      
      const url = `${SERVER}/api/v1/deploy/fr?fr-version=${fr}&structure-search-version=${ss}`;
      startStream(url, (xhr)=>{ 
        xhrFR = null; 
        setButtonState('btnDeployFR', false);
        setButtonState('btnAbortFR', false, true);
        fetchFRHistory(); // Refresh history to update input fields
      }, (x)=>{ xhrFR = x; });
    });

    document.getElementById('btnAbortFR').addEventListener('click', ()=>{
      if(xhrFR){ 
        setButtonState('btnAbortFR', true, true);
        xhrFR.abort(); 
        appendLine('UI and Middleware deploy aborted by user', 'warn'); 
        statusEl.textContent='Aborted'; 
        statusEl.style.color = 'var(--warn)';
        xhrFR=null; 
        isDeploying = false;
        setButtonState('btnDeployFR', false);
        setButtonState('btnAbortFR', false, true);
        fetchFRHistory(); // Refresh history to ensure input fields are updated
      }
      else appendLine('No UI and Middleware deploy in progress', 'warn');
    });

    // Deploy ML
    document.getElementById('btnDeployML').addEventListener('click', ()=>{
      if (isDeploying) {
        appendLine('Cannot start MARKLOGIC deployment: another deployment is in progress', 'warn');
        return;
      }
      terminal.innerHTML = '';
      logBuffer = '';
      statusEl.textContent = 'Starting MARKLOGIC deploy...';
      statusEl.style.color = 'var(--warn)';
      
      isDeploying = true;
      setButtonState('btnDeployML', true);
      setButtonState('btnAbortML', false, true);
      
      const url = `${SERVER}/api/v1/deploy/ml`;
      startStream(url, (xhr)=>{ 
        xhrML = null; 
        setButtonState('btnDeployML', false);
        setButtonState('btnAbortML', false, true);
        fetchMLHistory();
      }, (x)=>{ xhrML = x; });
    });

    document.getElementById('btnAbortML').addEventListener('click', ()=>{
      if(xhrML){ 
        setButtonState('btnAbortML', true, true);
        xhrML.abort(); 
        appendLine('MARKLOGIC deploy aborted by user', 'warn'); 
        statusEl.textContent='Aborted';
        statusEl.style.color = 'var(--warn)';
        xhrML=null; 
        isDeploying = false;
        setButtonState('btnDeployML', false);
        setButtonState('btnAbortML', false, true);
        fetchMLHistory();
      }
      else appendLine('No MARKLOGIC deploy in progress', 'warn');
    });

    // Copy and download logs
    document.getElementById('btnCopy').addEventListener('click', async ()=>{
      try{ 
        await navigator.clipboard.writeText(logBuffer||terminal.innerText); 
        appendLine('Log copied to clipboard', 'info'); 
      }
      catch(e){ appendLine('Copy failed: ' + e.message, 'stderr'); }
    });

    document.getElementById('btnDownload').addEventListener('click', ()=>{
      const blob = new Blob([logBuffer||terminal.innerText], {type:'text/plain;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `deploy-log-${Date.now()}.txt`;
      document.body.appendChild(a); a.click(); a.remove();
      appendLine('Log downloaded', 'info');
    });

    document.getElementById('btnClear').addEventListener('click', ()=>{ 
      terminal.innerHTML=''; 
      logBuffer=''; 
      appendLine('Terminal cleared', 'info'); 
    });

    // On page unload, abort any streaming xhr and stop auto theme change
    window.addEventListener('beforeunload', ()=>{ 
      if(xhrFR) xhrFR.abort(); 
      if(xhrML) xhrML.abort(); 
      stopAutoThemeChange();
    });

    // Initial fetch history
    fetchFRHistory();
    fetchMLHistory();

    // Initialize default theme
    applyTheme('blue');
  </script>
</body>
</html>
