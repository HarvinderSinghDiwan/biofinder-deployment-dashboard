
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deploy UI â€” Cyberpunk Centered Final Updated</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Orbitron:wght@700&display=swap');

    :root {
      --bg: #0a0a1a;
      --panel: rgba(20, 20, 30, 0.85);
      --neon: #00ffea;
      --neon-glow: rgba(0, 255, 234, 0.5);
      --text: #e0e0e0;
      --muted: #6b7280;
      --success: #10b981;
      --error: #f43f5e;
      --warn: #f59e0b;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Roboto Mono', monospace;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
    }

    .app {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      gap: 16px;
      height: 100vh;
      padding: 16px;
      max-width: 1400px;
      margin: 0 auto;
      box-sizing: border-box;
      overflow: hidden;
    }

    .panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: 100%;
      overflow: hidden;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--neon-glow);
      border-radius: 8px;
      padding: 14px;
      box-shadow: 0 0 12px var(--neon-glow);
      transition: box-shadow 0.3s ease;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 150px;
      max-height: 33.33%;
      box-sizing: border-box;
    }

    .card:hover {
      box-shadow: 0 0 20px var(--neon-glow);
    }

    .console-card {
      background: var(--panel);
      border: 1px solid var(--neon-glow);
      border-radius: 8px;
      padding: 14px;
      box-shadow: 0 0 12px var(--neon-glow);
      transition: box-shadow 0.3s ease;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      position: relative;
      height: 100%;
    }

    .console-card:hover {
      box-shadow: 0 0 20px var(--neon-glow);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-shrink: 0;
    }

    .h {
      font-family: 'Orbitron', sans-serif;
      font-size: 16px;
      color: var(--neon);
      text-transform: uppercase;
    }

    .meta {
      font-size: 11px;
      color: var(--muted);
    }

    .meta span {
      color: var(--neon);
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex-grow: 1;
      justify-content: space-between;
    }

    label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    input[type="text"] {
      width: 100%;
      padding: 6px;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid var(--neon);
      border-radius: 4px;
      color: var(--text);
      font-size: 11px;
      outline: none;
      transition: box-shadow 0.3s ease;
      box-sizing: border-box;
    }

    input[type="text"]:focus {
      box-shadow: 0 0 8px var(--neon-glow);
    }

    .row {
      display: flex;
      gap: 10px;
      margin-top: auto;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-family: 'Roboto Mono', monospace;
      font-size: 12px;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    .btn.primary {
      background: var(--neon);
      color: #000;
      box-shadow: 0 0 8px var(--neon-glow);
    }

    .btn.primary:hover {
      box-shadow: 0 0 16px var(--neon-glow);
      transform: scale(1.03);
    }

    .btn.ghost {
      background: transparent;
      border: 1px solid var(--neon);
      color: var(--neon);
    }

    .btn.ghost:hover {
      background: rgba(0, 255, 234, 0.1);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .switch-btn {
      position: fixed;
      top: 10px;
      left: 10px;
      background: linear-gradient(90deg, var(--neon), rgba(0, 255, 234, 0.7));
      color: #000;
      border: 2px solid var(--neon);
      padding: 8px 16px;
      border-radius: 6px;
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 0 10px var(--neon-glow);
      transition: all 0.3s ease;
      z-index: 1000;
      text-transform: uppercase;
    }

    .switch-btn:hover {
      box-shadow: 0 0 20px var(--neon-glow);
      transform: scale(1.05);
      animation: glitch 0.3s linear infinite;
    }

    @keyframes glitch {
      0% { transform: translate(0); }
      20% { transform: translate(-2px, 2px); }
      40% { transform: translate(-2px, -2px); }
      60% { transform: translate(2px, 2px); }
      80% { transform: translate(2px, -2px); }
      100% { transform: translate(0); }
    }

    .history-card {
      background: var(--panel);
      border: 1px solid var(--neon-glow);
      border-radius: 8px;
      padding: 14px;
      box-shadow: 0 0 12px var(--neon-glow);
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 150px;
      max-height: 33.33%;
      box-sizing: border-box;
    }

    .history-card:hover {
      box-shadow: 0 0 20px var(--neon-glow);
    }

    ul.history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      overflow-y: auto;
      flex-grow: 1;
      font-size: 11px;
    }

    ul.history-list li {
      padding: 6px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: color 0.3s ease;
      display: flex;
      align-items: center;
    }

    ul.history-list li:hover {
      color: var(--neon);
    }

    .history-item .datetime {
      font-size: 10px;
      color: var(--muted);
      display: block;
    }

    .history-item .build-id {
      font-weight: 700;
    }

    .history-item span:not(.datetime) {
      font-size: 11px;
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }

    .status-indicator.pass {
      background: var(--success);
      box-shadow: 0 0 5px var(--success);
    }

    .status-indicator.fail {
      background: var(--error);
      box-shadow: 0 0 5px var(--error);
    }

    .status-indicator.unknown {
      background: var(--muted);
      box-shadow: 0 0 5px var(--muted);
    }

    .terminal {
      background: #000;
      border-radius: 8px;
      padding: 14px;
      flex-grow: 1;
      overflow-y: auto;
      overflow-x: hidden;
      font-size: 12px;
      color: var(--text);
      margin-bottom: 48px;
      max-height: calc(100% - 38px - 48px); /* header (38px) + sticky buttons (48px) */
      box-sizing: border-box;
    }

    .line {
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.5;
    }

    .ts {
      color: var(--muted);
      margin-right: 8px;
    }

    .stdout { color: var(--success); }
    .stderr { color: var(--error); }
    .warn { color: var(--warn); }
    .info { color: var(--neon); }

    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 10, 26, 0.9);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      font-family: 'Orbitron', sans-serif;
      font-size: 24px;
      color: var(--neon);
      text-shadow: 0 0 12px var(--neon-glow);
      animation: pulse 1.5s ease-in-out infinite;
      text-align: center;
    }

    .loading-overlay.show {
      display: flex;
    }

    @keyframes pulse {
      0% { opacity: 0.5; text-shadow: 0 0 12px var(--neon-glow); }
      50% { opacity: 1; text-shadow: 0 0 24px var(--neon-glow); }
      100% { opacity: 0.5; text-shadow: 0 0 12px var(--neon-glow); }
    }

    .sticky-buttons {
      position: absolute;
      bottom: 14px;
      left: 14px;
      right: 14px;
      display: flex;
      gap: 12px;
      justify-content: center;
      background: var(--panel);
      padding: 8px;
      border-radius: 4px;
      box-shadow: 0 0 8px var(--neon-glow);
      flex-shrink: 0;
    }

    .toggle-auto {
      background: var(--neon);
      color: #000;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      font-family: 'Roboto Mono', monospace;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 0 0 8px var(--neon-glow);
      transition: all 0.3s ease;
    }

    .toggle-auto:hover {
      box-shadow: 0 0 16px var(--neon-glow);
    }

    .spinner {
      display: inline-block;
      width: 10px;
      height: 10px;
      border: 2px solid var(--neon);
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 1000px) {
      .app {
        grid-template-columns: 1fr;
        height: auto;
        overflow-y: auto;
      }

      .panel {
        gap: 8px;
      }

      .card, .history-card, .console-card {
        padding: 12px;
        max-height: none;
      }

      .terminal {
        max-height: 30vh;
        margin-bottom: 0;
      }

      .sticky-buttons {
        position: static;
        margin-top: 12px;
      }

      .loading-overlay {
        font-size: 18px;
      }

      .switch-btn {
        top: 8px;
        left: 8px;
        padding: 6px 12px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <button id="modeToggle" class="switch-btn">DEV</button>
  <div id="loading-overlay" class="loading-overlay">LOADING...</div>
  <div class="app">
    <div class="panel">
      <div id="uiMiddlewareCard" class="card">
        <div class="header">
          <div>
            <div class="h">UI + Middleware</div>
            <div class="meta">SERVER: <span class="server-url">api.dashboard.dev-full.lifesciences-dev.casinternal:8080</span></div>
          </div>
        </div>
        <div class="controls">
          <label>UI and Middleware Version</label>
          <input id="frVersion" type="text" placeholder="e.g. 1.2.3" />
          <label>Structure Search Version</label>
          <input id="structureVersion" type="text" placeholder="e.g. 2025-09-01" />
          <div class="row">
            <button id="btnDeployFR" class="btn primary">Deploy</button>
            <button id="btnAbortFR" class="btn ghost">Abort</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="header">
          <div>
            <div class="h">Corb Jobs</div>
            <div class="meta">SERVER: <span class="server-url">api.dashboard.dev-full.lifesciences-dev.casinternal:8080</span></div>
          </div>
        </div>
        <div class="controls">
          <label>Job Name</label>
          <input id="cjJobName" type="text" placeholder="e.g. job-123" />
          <div style="flex-grow: 1;"></div>
          <div class="row">
            <button id="btnRunCJ" class="btn primary">Run</button>
            <button id="btnAbortCJ" class="btn ghost">Abort</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="header">
          <div>
            <div class="h">MARKLOGIC</div>
            <div class="meta">SERVER: <span class="server-url">api.dashboard.dev-full.lifesciences-dev.casinternal:8080</span></div>
          </div>
        </div>
        <div class="controls">
          <div style="flex-grow: 1;"></div>
          <div class="row">
            <button id="btnDeployML" class="btn primary">Deploy</button>
            <button id="btnAbortML" class="btn ghost">Abort</button>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="console-card">
        <div class="header">
          <div class="h">Live Console</div>
          <div class="meta" id="status">Idle</div>
        </div>
        <div id="terminal" class="terminal" aria-live="polite"></div>
        <div class="sticky-buttons">
          <button id="btnCopy" class="btn ghost">Copy</button>
          <button id="btnDownload" class="btn ghost">Download Log</button>
          <button id="btnClear" class="btn ghost">Clear Terminal</button>
          <button id="toggleAuto" class="btn toggle-auto">Stop Auto-Change</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <div id="uiMiddlewareHistoryCard" class="history-card">
        <div class="header">
          <div class="h">UI + Middleware History</div>
        </div>
        <ul id="frHistory" class="history-list"></ul>
      </div>

      <div class="history-card">
        <div class="header">
          <div class="h">Corb Jobs History</div>
        </div>
        <ul id="cjHistory" class="history-list"></ul>
      </div>

      <div class="history-card">
        <div class="header">
          <div class="h">MARKLOGIC History</div>
        </div>
        <ul id="mlHistory" class="history-list"></ul>
      </div>
    </div>
  </div>

  <script>
    let currentMode = 'dev';
    let SERVER = getServer(currentMode);
    const uiMiddlewareCard = document.getElementById('uiMiddlewareCard');
    const uiMiddlewareHistoryCard = document.getElementById('uiMiddlewareHistoryCard');

    function getServer(mode) {
      return `http://${mode === 'dev' ? 'api.dashboard.dev-full.lifesciences-dev.casinternal' : 'api.dashboard.ingestion.lifesciences-dev.casinternal'}:8080`;
    }

    function updateServerMeta() {
      try {
        document.querySelectorAll('.server-url').forEach(span => {
          span.textContent = SERVER.substring(7);
        });
      } catch (e) {
        console.error('Error updating server meta:', e);
        appendLine('Error updating server meta: ' + e.message, 'stderr');
      }
    }

    function toggleUIMiddlewareSections() {
      try {
        uiMiddlewareCard.style.display = currentMode === 'dev' ? 'flex' : 'none';
        uiMiddlewareHistoryCard.style.display = currentMode === 'dev' ? 'flex' : 'none';
      } catch (e) {
        console.error('Error toggling UI sections:', e);
        appendLine('Error toggling UI sections: ' + e.message, 'stderr');
      }
    }

    document.getElementById('modeToggle').addEventListener('click', () => {
      try {
        currentMode = currentMode === 'dev' ? 'ingestion' : 'dev';
        SERVER = getServer(currentMode);
        updateServerMeta();
        toggleUIMiddlewareSections();
        // Clear history lists and inputs
        document.getElementById('frHistory').innerHTML = '';
        document.getElementById('cjHistory').innerHTML = '';
        document.getElementById('mlHistory').innerHTML = '';
        if (currentMode === 'dev') {
          document.getElementById('frVersion').value = '';
          document.getElementById('structureVersion').value = '';
        }
        document.getElementById('cjJobName').value = '';
        // Clear console
        terminal.innerHTML = '';
        logBuffer = '';
        statusEl.textContent = 'Idle';
        statusEl.style.color = 'var(--muted)';
        // Update button text
        const toggleButton = document.getElementById('modeToggle');
        toggleButton.textContent = currentMode === 'dev' ? 'DEV' : 'INGESTION';
        // Fetch new data
        fetchFRHistory();
        fetchMLHistory();
        fetchCJHistory();
      } catch (e) {
        console.error('Error switching mode:', e);
        appendLine('Error switching mode: ' + e.message, 'stderr');
      }
    });

    const COLOR_CHANGE_INTERVAL = 5000;
    const RGB_EXTENDED_INTERVAL = 10000; // 5s regular + 5s for RGB

    const themes = {
      red: {
        '--neon': '#ef4444',
        '--neon-glow': 'rgba(239, 68, 68, 0.5)',
        '--panel': 'rgba(20, 25, 30, 0.85)',
        '--bg': '#0a0a1a',
        '--success': '#10b981',
        '--error': '#ef4444',
        '--warn': '#f59e0b'
      },
      black: {
        '--neon': '#334155',
        '--neon-glow': 'rgba(51, 65, 85, 0.5)',
        '--panel': 'rgba(30, 30, 30, 0.85)',
        '--bg': '#0a0a0a',
        '--success': '#10b981',
        '--error': '#334155',
        '--warn': '#f59e0b'
      },
      purple: {
        '--neon': '#7e22ce',
        '--neon-glow': 'rgba(126, 34, 206, 0.5)',
        '--panel': 'rgba(30, 25, 40, 0.85)',
        '--bg': '#1a0a1a',
        '--success': '#10b981',
        '--error': '#7e22ce',
        '--warn': '#f59e0b'
      },
      blue: {
        '--neon': '#1e40af',
        '--neon-glow': 'rgba(30, 64, 175, 0.5)',
        '--panel': 'rgba(25, 30, 40, 0.85)',
        '--bg': '#0a0a2f',
        '--success': '#10b981',
        '--error': '#1e40af',
        '--warn': '#f59e0b'
      },
      green: {
        '--neon': '#15803d',
        '--neon-glow': 'rgba(21, 128, 61, 0.5)',
        '--panel': 'rgba(25, 35, 30, 0.85)',
        '--bg': '#0a1a0a',
        '--success': '#10b981',
        '--error': '#15803d',
        '--warn': '#f59e0b'
      },
      orange: {
        '--neon': '#ea580c',
        '--neon-glow': 'rgba(234, 88, 12, 0.5)',
        '--panel': 'rgba(35, 30, 25, 0.85)',
        '--bg': '#1a0f0a',
        '--success': '#10b981',
        '--error': '#ea580c',
        '--warn': '#f59e0b'
      },
      cyan: {
        '--neon': '#00ffea',
        '--neon-glow': 'rgba(0, 255, 234, 0.5)',
        '--panel': 'rgba(20, 20, 30, 0.85)',
        '--bg': '#0a0a1a',
        '--success': '#10b981',
        '--error': '#00ffea',
        '--warn': '#f59e0b'
      },
      pink: {
        '--neon': '#ec4899',
        '--neon-glow': 'rgba(236, 72, 153, 0.5)',
        '--panel': 'rgba(30, 25, 35, 0.85)',
        '--bg': '#1a0a1f',
        '--success': '#10b981',
        '--error': '#ec4899',
        '--warn': '#f59e0b'
      },
      yellow: {
        '--neon': '#eab308',
        '--neon-glow': 'rgba(234, 179, 8, 0.5)',
        '--panel': 'rgba(35, 30, 25, 0.85)',
        '--bg': '#1a0f0a',
        '--success': '#10b981',
        '--error': '#eab308',
        '--warn': '#f59e0b'
      },
      teal: {
        '--neon': '#14b8a6',
        '--neon-glow': 'rgba(20, 184, 166, 0.5)',
        '--panel': 'rgba(25, 35, 30, 0.85)',
        '--bg': '#0a1a1a',
        '--success': '#10b981',
        '--error': '#14b8a6',
        '--warn': '#f59e0b'
      },
      rgb: {
        '--neon': 'rgb(255, 0, 0)', // Initial color, will be updated dynamically
        '--neon-glow': 'rgba(255, 0, 0, 0.5)', // Initial glow, will be updated
        '--panel': 'rgba(20, 20, 30, 0.85)',
        '--bg': '#0a0a1a',
        '--success': '#10b981',
        '--error': 'rgb(255, 0, 0)', // Initial error color, will be updated
        '--warn': '#f59e0b'
      }
    };

    const themeKeys = ['red', 'black', 'purple', 'blue', 'green', 'orange', 'cyan', 'pink', 'yellow', 'teal', 'rgb'];
    let currentThemeIndex = 6; // Start with cyan
    let isAutoChangeEnabled = true;
    let autoThemeInterval = null;
    let rgbPhase = 0;

    function applyTheme(themeName) {
      try {
        if (themeName === 'rgb') {
          const r = Math.sin(rgbPhase) * 127 + 128;
          const g = Math.sin(rgbPhase + 2) * 127 + 128;
          const b = Math.sin(rgbPhase + 4) * 127 + 128;
          document.documentElement.style.setProperty('--neon', `rgb(${r}, ${g}, ${b})`);
          document.documentElement.style.setProperty('--neon-glow', `rgba(${r}, ${g}, ${b}, 0.5)`);
          document.documentElement.style.setProperty('--error', `rgb(${r}, ${g}, ${b})`);
          document.documentElement.style.setProperty('--panel', themes.rgb['--panel']);
          document.documentElement.style.setProperty('--bg', themes.rgb['--bg']);
          document.documentElement.style.setProperty('--success', themes.rgb['--success']);
          document.documentElement.style.setProperty('--warn', themes.rgb['--warn']);
          rgbPhase += 0.1; // Increment phase for smooth color transition
        } else {
          const theme = themes[themeName];
          for (const [key, value] of Object.entries(theme)) {
            document.documentElement.style.setProperty(key, value);
          }
        }
      } catch (e) {
        console.error('Error applying theme:', e);
        appendLine('Error applying theme: ' + e.message, 'stderr');
      }
    }

    function startAutoThemeChange() {
      if (!isAutoChangeEnabled) return;
      stopAutoThemeChange();
      autoThemeInterval = setInterval(() => {
        try {
          const currentTheme = themeKeys[currentThemeIndex];
          applyTheme(currentTheme);
          const nextTheme = themeKeys[(currentThemeIndex + 1) % themeKeys.length];
          currentThemeIndex = (currentThemeIndex + 1) % themeKeys.length;
          // Adjust interval: 10s (5s + 5s) for RGB, 5s for others
          const interval = currentTheme === 'rgb' ? RGB_EXTENDED_INTERVAL : COLOR_CHANGE_INTERVAL;
          stopAutoThemeChange();
          autoThemeInterval = setInterval(startAutoThemeChange, interval);
        } catch (e) {
          console.error('Error in theme change:', e);
          appendLine('Error in theme change: ' + e.message, 'stderr');
        }
      }, COLOR_CHANGE_INTERVAL);
    }

    function stopAutoThemeChange() {
      if (autoThemeInterval) {
        clearInterval(autoThemeInterval);
        autoThemeInterval = null;
      }
    }

    document.getElementById('toggleAuto').addEventListener('click', () => {
      try {
        isAutoChangeEnabled = !isAutoChangeEnabled;
        const toggleButton = document.getElementById('toggleAuto');
        toggleButton.textContent = isAutoChangeEnabled ? 'Stop Auto-Change' : 'Start Auto-Change';
        toggleButton.style.background = isAutoChangeEnabled ? 'var(--neon)' : 'rgba(255, 255, 255, 0.1)';
        toggleButton.style.color = isAutoChangeEnabled ? '#000' : 'var(--muted)';
        if (isAutoChangeEnabled) {
          startAutoThemeChange();
        } else {
          stopAutoThemeChange();
        }
      } catch (e) {
        console.error('Error toggling auto theme:', e);
        appendLine('Error toggling auto theme: ' + e.message, 'stderr');
      }
    });

    startAutoThemeChange();

    const terminal = document.getElementById('terminal');
    const statusEl = document.getElementById('status');
    const loadingOverlay = document.getElementById('loading-overlay');
    let lastIndex = 0;
    let xhrFR = null, xhrML = null, xhrCJ = null;
    let logBuffer = '';
    let isDeploying = false;

    function appendLine(text, kind='stdout') {
      try {
        const parts = text.replace(/\r/g,'').split(/\n/);
        parts.forEach((p, idx) => {
          if (!p) return;
          const ts = new Date().toLocaleTimeString();
          const line = document.createElement('div');
          line.className = 'line ' + (kind === 'stderr' ? 'stderr' : kind === 'warn' ? 'warn' : kind === 'info' ? 'info' : 'stdout');
          line.innerHTML = '<span class="ts">[' + ts + ']</span>' + escapeHtml(p);
          terminal.appendChild(line);
          logBuffer += '[' + ts + '] ' + p + '\n';
          const isNearBottom = terminal.scrollTop + terminal.clientHeight >= terminal.scrollHeight - 50;
          if (isNearBottom) {
            terminal.scrollTop = terminal.scrollHeight;
          }
        });
      } catch (e) {
        console.error('Error appending line:', e);
      }
    }

    function escapeHtml(s) {
      return s.replace(/[&<>\"']/g, function(c) { return {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[c]; });
    }

    function processChunk(chunk) {
      try {
        const lines = chunk.split(/\r?\n/);
        lines.forEach(l => {
          if (!l) return;
          if (/error/i.test(l) || /traceback/i.test(l) || /failed/i.test(l)) appendLine(l, 'stderr');
          else if (/warn/i.test(l)) appendLine(l, 'warn');
          else if (/info/i.test(l)) appendLine(l, 'info');
          else appendLine(l, 'stdout');
        });
      } catch (e) {
        console.error('Error processing chunk:', e);
        appendLine('Error processing chunk: ' + e.message, 'stderr');
      }
    }

    function setButtonState(buttonId, isLoading, isAbort = false) {
      try {
        const btn = document.getElementById(buttonId);
        const otherDeployBtns = [
          document.getElementById('btnDeployFR'),
          document.getElementById('btnDeployML'),
          document.getElementById('btnRunCJ')
        ].filter(b => b && b.id !== buttonId);
        if (isLoading) {
          btn.disabled = true;
          btn.innerHTML = isLoading ? 
            '<span class="spinner"></span> ' + (isAbort ? 'Aborting...' : (buttonId === 'btnRunCJ' ? 'Running...' : 'Deploying...')) : 
            btn.textContent;
          otherDeployBtns.forEach(b => b.disabled = true);
        } else {
          btn.disabled = false;
          btn.innerHTML = isAbort ? 'Abort' : 
            (buttonId === 'btnDeployFR' ? 'Deploy' : 
             buttonId === 'btnDeployML' ? 'Deploy' : 'Run');
          if (!isDeploying) {
            otherDeployBtns.forEach(b => b.disabled = false);
          }
        }
      } catch (e) {
        console.error('Error setting button state:', e);
        appendLine('Error setting button state: ' + e.message, 'stderr');
      }
    }

    function startStream(url, onDone, assignXhr) {
      try {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.timeout = 0;
        xhr.onreadystatechange = function() {
          try {
            if (xhr.readyState === 2) { 
              statusEl.textContent = 'Connected'; 
              statusEl.style.color = 'var(--success)';
            }
            if (xhr.readyState === 4) {
              if (xhr.status >= 400) {
                statusEl.textContent = 'Failed (' + xhr.status + ')';
                statusEl.style.color = 'var(--error)';
                appendLine('HTTP ' + xhr.status + ' returned from server', 'stderr');
              } else {
                statusEl.textContent = 'Complete (' + xhr.status + ')';
                statusEl.style.color = 'var(--success)';
              }
              isDeploying = false;
              if (onDone) onDone(xhr);
            }
          } catch (e) {
            console.error('Error in stream state change:', e);
            appendLine('Error in stream state change: ' + e.message, 'stderr');
          }
        };

        let lastLen = 0;
        xhr.onprogress = function() {
          try {
            const text = xhr.responseText.substring(lastLen);
            lastLen = xhr.responseText.length;
            if (text) processChunk(text);
          } catch (e) {
            console.error('Error in stream progress:', e);
            appendLine('Error in stream progress: ' + e.message, 'stderr');
          }
        };

        xhr.onerror = function() { 
          statusEl.textContent = 'Network Error'; 
          statusEl.style.color = 'var(--error)';
          appendLine('Network error while streaming', 'stderr'); 
          isDeploying = false;
        };
        
        xhr.ontimeout = function() { 
          statusEl.textContent = 'Timeout'; 
          statusEl.style.color = 'var(--error)';
          appendLine('Streaming timed out', 'stderr'); 
          isDeploying = false;
        };

        xhr.send();
        assignXhr(xhr);
      } catch (e) {
        console.error('Error starting stream:', e);
        appendLine('Error starting stream: ' + e.message, 'stderr');
      }
    }

    function validateInputs() {
      try {
        const fr = document.getElementById('frVersion').value.trim();
        const ss = document.getElementById('structureVersion').value.trim();
        
        if (!fr) {
          appendLine('UI and Middleware version is required', 'stderr');
          return false;
        }
        
        if (!ss) {
          appendLine('Structure Search version is required', 'stderr');
          return false;
        }
        
        return true;
      } catch (e) {
        console.error('Error validating inputs:', e);
        appendLine('Error validating inputs: ' + e.message, 'stderr');
        return false;
      }
    }

    function validateCJInput() {
      try {
        const jobName = document.getElementById('cjJobName').value.trim();
        if (!jobName) {
          appendLine('Job Name is required', 'stderr');
          return false;
        }
        return true;
      } catch (e) {
        console.error('Error validating CJ input:', e);
        appendLine('Error validating CJ input: ' + e.message, 'stderr');
        return false;
      }
    }

    function fetchFRHistory() {
      if (currentMode !== 'dev') {
        document.getElementById('frHistory').innerHTML = '';
        return;
      }
      fetch(`${SERVER}/api/v1/history/fr`)
        .then(res => res.json())
        .then(data => {
          try {
            const sorted = data.sort((a, b) => new Date(b.datetime) - new Date(a.datetime)).slice(0, 20);
            const ul = document.getElementById('frHistory');
            ul.innerHTML = '';
            if (sorted.length > 0) {
              const latest = sorted[0];
              document.getElementById('frVersion').value = latest['fr-version'] || '';
              document.getElementById('structureVersion').value = latest['structure-search-version'] || '';
            }
            sorted.forEach(item => {
              const date = new Date(item.datetime).toLocaleDateString();
              const time = new Date(item.datetime).toLocaleTimeString();
              const statusClass = item.status === 'pass' ? 'pass' : item.status === 'fail' ? 'fail' : 'unknown';
              const li = document.createElement('li');
              li.innerHTML = `
                <div class="history-item">
                  <span class="status-indicator ${statusClass}"></span>
                  <span class="build-id">${escapeHtml(item.buildId)}</span>
                  <span class="datetime">${date} ${time}</span>
                  <span>UI: ${escapeHtml(item['fr-version'] || 'N/A')}</span>
                  <span>SS: ${escapeHtml(item['structure-search-version'] || 'N/A')}</span>
                </div>
              `;
              li.style.cursor = 'pointer';
              li.onclick = () => viewLogs('fr', item.buildId);
              ul.appendChild(li);
            });
          } catch (e) {
            console.error('Error processing FR history:', e);
            appendLine('Error processing FR history: ' + e.message, 'stderr');
          }
        })
        .catch(err => appendLine('Error fetching UI and Middleware history: ' + err.message, 'stderr'));
    }

    function fetchMLHistory() {
      fetch(`${SERVER}/api/v1/history/ml`)
        .then(res => res.json())
        .then(data => {
          try {
            const sorted = data.sort((a, b) => new Date(b.datetime) - new Date(a.datetime)).slice(0, 20);
            const ul = document.getElementById('mlHistory');
            ul.innerHTML = '';
            sorted.forEach(item => {
              const date = new Date(item.datetime).toLocaleDateString();
              const time = new Date(item.datetime).toLocaleTimeString();
              const statusClass = item.status === 'pass' ? 'pass' : item.status === 'fail' ? 'fail' : 'unknown';
              const li = document.createElement('li');
              li.innerHTML = `
                <div class="history-item">
                  <span class="status-indicator ${statusClass}"></span>
                  <span class="build-id">${escapeHtml(item.buildId)}</span>
                  <span class="datetime">${date} ${time}</span>
                </div>
              `;
              li.style.cursor = 'pointer';
              li.onclick = () => viewLogs('ml', item.buildId);
              ul.appendChild(li);
            });
          } catch (e) {
            console.error('Error processing ML history:', e);
            appendLine('Error processing ML history: ' + e.message, 'stderr');
          }
        })
        .catch(err => appendLine('Error fetching MARKLOGIC history: ' + err.message, 'stderr'));
    }

    function fetchCJHistory() {
      fetch(`${SERVER}/api/v1/history/cj`)
        .then(res => res.json())
        .then(data => {
          try {
            const sorted = data.sort((a, b) => new Date(b.datetime) - new Date(a.datetime)).slice(0, 20);
            const ul = document.getElementById('cjHistory');
            ul.innerHTML = '';
            if (sorted.length > 0) {
              const latest = sorted[0];
              document.getElementById('cjJobName').value = latest['jobName'] || '';
            }
            sorted.forEach(item => {
              const date = new Date(item.datetime).toLocaleDateString();
              const time = new Date(item.datetime).toLocaleTimeString();
              const statusClass = item.status === 'pass' ? 'pass' : item.status === 'fail' ? 'fail' : 'unknown';
              const li = document.createElement('li');
              li.innerHTML = `
                <div class="history-item">
                  <span class="status-indicator ${statusClass}"></span>
                  <span class="build-id">${escapeHtml(item.buildId)}</span>
                  <span class="datetime">${date} ${time}</span>
                  <span>Job: ${escapeHtml(item['jobName'] || 'N/A')}</span>
                </div>
              `;
              li.style.cursor = 'pointer';
              li.onclick = () => viewLogs('cj', item.buildId);
              ul.appendChild(li);
            });
          } catch (e) {
            console.error('Error processing CJ history:', e);
            appendLine('Error processing CJ history: ' + e.message, 'stderr');
          }
        })
        .catch(err => appendLine('Error fetching Corb Jobs history: ' + err.message, 'stderr'));
    }

    function viewLogs(type, buildId) {
      try {
        terminal.innerHTML = '';
        logBuffer = '';
        statusEl.textContent = `Viewing ${type.toUpperCase()} Build ${buildId} Logs`;
        statusEl.style.color = 'var(--muted)';
        loadingOverlay.classList.add('show');
        fetch(`${SERVER}/api/v1/history/${type}?buildId=${buildId}`)
          .then(res => res.json())
          .then(data => {
            loadingOverlay.classList.remove('show');
            if (data && data.output_log) {
              processChunk(data.output_log);
            } else {
              appendLine('No output log available for this build', 'warn');
            }
          })
          .catch(err => {
            loadingOverlay.classList.remove('show');
            appendLine('Error fetching logs: ' + err.message, 'stderr');
          });
      } catch (e) {
        console.error('Error viewing logs:', e);
        appendLine('Error viewing logs: ' + e.message, 'stderr');
      }
    }

    document.getElementById('btnDeployFR').addEventListener('click', () => {
      try {
        if (isDeploying) {
          appendLine('Cannot start UI and Middleware deployment: another deployment is in progress', 'warn');
          return;
        }
        if (!validateInputs()) return;
        
        const fr = encodeURIComponent(document.getElementById('frVersion').value.trim());
        const ss = encodeURIComponent(document.getElementById('structureVersion').value.trim());
        
        terminal.innerHTML = '';
        logBuffer = '';
        lastIndex = 0;
        statusEl.textContent = 'Starting UI and Middleware deploy...';
        statusEl.style.color = 'var(--warn)';
        
        isDeploying = true;
        setButtonState('btnDeployFR', true);
        setButtonState('btnAbortFR', false, true);
        
        const url = `${SERVER}/api/v1/deploy/fr?fr-version=${fr}&structure-search-version=${ss}`;
        startStream(url, (xhr) => { 
          xhrFR = null; 
          setButtonState('btnDeployFR', false);
          setButtonState('btnAbortFR', false, true);
          fetchFRHistory();
        }, (x) => { xhrFR = x; });
      } catch (e) {
        console.error('Error deploying FR:', e);
        appendLine('Error deploying FR: ' + e.message, 'stderr');
      }
    });

    document.getElementById('btnAbortFR').addEventListener('click', () => {
      try {
        if (xhrFR) { 
          setButtonState('btnAbortFR', true, true);
          xhrFR.abort(); 
          appendLine('UI and Middleware deploy aborted by user', 'warn'); 
          statusEl.textContent = 'Aborted'; 
          statusEl.style.color = 'var(--warn)';
          xhrFR = null; 
          isDeploying = false;
          setButtonState('btnDeployFR', false);
          setButtonState('btnAbortFR', false, true);
          fetchFRHistory();
        } else {
          appendLine('No UI and Middleware deploy in progress', 'warn');
        }
      } catch (e) {
        console.error('Error aborting FR:', e);
        appendLine('Error aborting FR: ' + e.message, 'stderr');
      }
    });

    document.getElementById('btnDeployML').addEventListener('click', () => {
      try {
        if (isDeploying) {
          appendLine('Cannot start MARKLOGIC deployment: another deployment is in progress', 'warn');
          return;
        }
        terminal.innerHTML = '';
        logBuffer = '';
        statusEl.textContent = 'Starting MARKLOGIC deploy...';
        statusEl.style.color = 'var(--warn)';
        
        isDeploying = true;
        setButtonState('btnDeployML', true);
        setButtonState('btnAbortML', false, true);
        
        const url = `${SERVER}/api/v1/deploy/ml`;
        startStream(url, (xhr) => { 
          xhrML = null; 
          setButtonState('btnDeployML', false);
          setButtonState('btnAbortML', false, true);
          fetchMLHistory();
        }, (x) => { xhrML = x; });
      } catch (e) {
        console.error('Error deploying ML:', e);
        appendLine('Error deploying ML: ' + e.message, 'stderr');
      }
    });

    document.getElementById('btnAbortML').addEventListener('click', () => {
      try {
        if (xhrML) { 
          setButtonState('btnAbortML', true, true);
          xhrML.abort(); 
          appendLine('MARKLOGIC deploy aborted by user', 'warn'); 
          statusEl.textContent = 'Aborted';
          statusEl.style.color = 'var(--warn)';
          xhrML = null; 
          isDeploying = false;
          setButtonState('btnDeployML', false);
          setButtonState('btnAbortML', false, true);
          fetchMLHistory();
        } else {
          appendLine('No MARKLOGIC deploy in progress', 'warn');
        }
      } catch (e) {
        console.error('Error aborting ML:', e);
        appendLine('Error aborting ML: ' + e.message, 'stderr');
      }
    });

    document.getElementById('btnRunCJ').addEventListener('click', () => {
      try {
        if (isDeploying) {
          appendLine('Cannot start Corb Jobs run: another deployment is in progress', 'warn');
          return;
        }
        if (!validateCJInput()) return;
        
        const jobName = encodeURIComponent(document.getElementById('cjJobName').value.trim());
        
        terminal.innerHTML = '';
        logBuffer = '';
        lastIndex = 0;
        statusEl.textContent = 'Starting Corb Jobs run...';
        statusEl.style.color = 'var(--warn)';
        
        isDeploying = true;
        setButtonState('btnRunCJ', true);
        setButtonState('btnAbortCJ', false, true);
        
        const url = `${SERVER}/api/v1/run/cj?job-name=${jobName}`;
        startStream(url, (xhr) => { 
          xhrCJ = null; 
          setButtonState('btnRunCJ', false);
          setButtonState('btnAbortCJ', false, true);
          fetchCJHistory();
        }, (x) => { xhrCJ = x; });
      } catch (e) {
        console.error('Error running CJ:', e);
        appendLine('Error running CJ: ' + e.message, 'stderr');
      }
    });

    document.getElementById('btnAbortCJ').addEventListener('click', () => {
      try {
        if (xhrCJ) { 
          setButtonState('btnAbortCJ', true, true);
          xhrCJ.abort(); 
          appendLine('Corb Jobs run aborted by user', 'warn'); 
          statusEl.textContent = 'Aborted';
          statusEl.style.color = 'var(--warn)';
          xhrCJ = null; 
          isDeploying = false;
          setButtonState('btnRunCJ', false);
          setButtonState('btnAbortCJ', false, true);
          fetchCJHistory();
        } else {
          appendLine('No Corb Jobs run in progress', 'warn');
        }
      } catch (e) {
        console.error('Error aborting CJ:', e);
        appendLine('Error aborting CJ: ' + e.message, 'stderr');
      }
    });

    document.getElementById('btnCopy').addEventListener('click', async () => {
      try { 
        await navigator.clipboard.writeText(logBuffer || terminal.innerText); 
        appendLine('Log copied to clipboard', 'info'); 
      } catch (e) { 
        console.error('Error copying log:', e);
        appendLine('Copy failed: ' + e.message, 'stderr'); 
      }
    });

    document.getElementById('btnDownload').addEventListener('click', () => {
      try {
        const blob = new Blob([logBuffer || terminal.innerText], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `deploy-log-${Date.now()}.txt`;
        document.body.appendChild(a); 
        a.click(); 
        a.remove();
        appendLine('Log downloaded', 'info');
      } catch (e) {
        console.error('Error downloading log:', e);
        appendLine('Error downloading log: ' + e.message, 'stderr');
      }
    });

    document.getElementById('btnClear').addEventListener('click', () => { 
      try {
        terminal.innerHTML = ''; 
        logBuffer = ''; 
        appendLine('Terminal cleared', 'info'); 
        loadingOverlay.classList.remove('show');
      } catch (e) {
        console.error('Error clearing terminal:', e);
        appendLine('Error clearing terminal: ' + e.message, 'stderr');
      }
    });

    window.addEventListener('beforeunload', () => { 
      try {
        if (xhrFR) xhrFR.abort(); 
        if (xhrML) xhrML.abort(); 
        if (xhrCJ) xhrCJ.abort(); 
        stopAutoThemeChange();
      } catch (e) {
        console.error('Error on beforeunload:', e);
      }
    });

    // Initial setup
    try {
      updateServerMeta();
      toggleUIMiddlewareSections();
      fetchFRHistory();
      fetchMLHistory();
      fetchCJHistory();
      applyTheme('cyan');
    } catch (e) {
      console.error('Error during initial setup:', e);
      appendLine('Error during initial setup: ' + e.message, 'stderr');
    }
  </script>
</body>
</html>
